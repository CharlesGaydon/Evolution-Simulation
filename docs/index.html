<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Plasmid Visualisation</title>

</head>

<style>
text {
  font-family: "Helvetica Neue", Helvetica, sans-serif;
  font-size: 12px;
  font-weight: bold;
  fill: white;
  text-anchor: middle;
}
path {
  
  stroke: white;
}
</style>

<body>
  <input id="slider" type="range" min="1" max="5" value="1" step="1" />
  <span id="range"></span>
  <button name="play" id="play">Play</button>
  <svg width="1000" height="500">
    <g transform="translate(300, 250)"></g>
  </svg>

  <script src="js/d3.min.js"></script>
  <script>

// inspiration : https://bl.ocks.org/d3indepth/c9fd848b9410cc543a437b34c266ac64
// Create an arc generator with configuration
var arcGenerator = d3.arc()
  .innerRadius(150)
  .outerRadius(200);
/*
var arcData = [
  {label: 'A', startAngle: 0, endAngle: 0.2},
  {label: 'B', startAngle: 0.2, endAngle: 0.6},
  {label: 'C', startAngle: 0.6, endAngle: 1.4},
  {label: 'D', startAngle: 1.4, endAngle: 3},
  {label: 'E', startAngle: 3, endAngle: 2* Math.PI}
];*/

function colcode(d){
  if(d.data.id.charAt(0) == "g"){
    return("green");
  }else{
    return("#dbdbdb");
  }
}
//slider
var slider = document.getElementById("slider");
var ts = document.getElementById("range");
ts.innerHTML = "1"; // Display the default slider value
slider.oninput = function() {
  ts.innerHTML = this.value;
}



d3.csv("/data/sample_plasmid.csv", function(error, data) {
  if (error) throw error;
  // accessors
  columns = Object.keys( data[0] ).slice()
  var nb_col = columns.length
  var t_max = (nb_col-1)/3
  slider.max = t_max


  function update(ts){
    console.log("update called with ts")
    console.log(ts)

    var pos = "pos"+ts.toString()
    var length = "length"+ts.toString()
    var arcs = d3.pie()
        .sort(function(a,b){
          return a[pos]<(b[pos])
        })
        .value(function(d) {return d[length];})(data);

    console.log(arcs)

    var paths = d3.select('g')
                    .selectAll('path')
                    .data(arcs)
                    
    paths.transition().duration(400).attr('d', arcGenerator)
    //  .attr("fill", function(d){console.log(colcode(d));return colcode(d)})

    // Add labels, using .centroid() to position
    
   d3.select('g')
      .selectAll('text')
      .data(arcs)
      .each(function(d) {
        var centroid = arcGenerator.centroid(d);
        d3.select(this)
          .attr('x', centroid[0])
          .attr('y', centroid[1])
          .attr('dy', '0.33em')
          .text(d.data.id);
    })
  }
    /// Initialisation
    var pos = "pos1"
    var length = "length1"
    var arcs = d3.pie()
        .sort(function(a,b){
          return a[pos]<(b[pos])
        })
        .value(function(d) {console.log(length,d[length]); return d[length]; })(data);

    console.log(arcs)
      d3.select('g')
      .selectAll('path')
      .data(arcs)
      .enter()
      .append('path')
      .attr('d', arcGenerator)
      .attr("fill", function(d){console.log(colcode(d));return colcode(d)})

    // Add labels, using .centroid() to position
    d3.select('g')
      .selectAll('text')
      .data(arcs)
      .enter()
      .append('text')
      .each(function(d) {
        var centroid = arcGenerator.centroid(d);
        d3.select(this)
          .attr('x', centroid[0])
          .attr('y', centroid[1])
          .attr('dy', '0.33em')
          .text(d.data.id);
    })
  // other elements
  d3.select("#slider").on("input", function() {
    update(+this.value);
  });

  // Player 
//var i = 0
//setInterval(function(){update(1+i%2); console.log(i%2);i++;},600)    


function step(){
  current_ts=parseInt(slider.value)+1
  console.log(current_ts,t_max)
  if (current_ts > t_max) {
    moving = false;
    //current_ts = 0;
    clearInterval(timer);
    // timer = 0;
    playButton.text("Play");
    console.log("Slider moving: " + moving);
  }else{
    slider.value+=1
    ts.innerHTML = slider.value; 
    update(slider.value)
  }
}

var playButton = d3.select("#play");

playButton.on("click",function(){
  var button = d3.select(this)
  if (button.text() == "Pause") {
      moving = false;
      clearInterval(timer);
      // timer = 0;
      button.text("Play");
    } else {
      moving = true;
      timer = setInterval(step,600);
      button.text("Pause");
    }
    console.log("Slider moving: " + moving);  
})

}) 
  </script>
</body>
</html>
