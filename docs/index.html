<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Plasmid Visualisation</title>

</head>

<style>
text {
  font-family: "Helvetica Neue", Helvetica, sans-serif;
  font-size: 12px;
  font-weight: bold;
  fill: white;
  text-anchor: middle;
}
path {
  
  stroke: white;
}
</style>

<body>
  <div margin-left="200" style="color:#0000FF" transform="translate(50, 250)">
    <h3>Plasmid evolution simulation</h3>
  </div>
  <div width="500" height="100" transform="translate(50, 250)">
    <input id="slider" type="range" min="0" max="2" value="0" step="1" />
    <span id="range"></span>
    <button name="play" id="play">Play</button>
  </div>

  <div display="flex" height="500" width = "1000">
    <svg float="left" width="50%" height="300" flex="1">
      <g transform="translate(155, 145)"></g>
    </svg>

    <svg float="left" width="40%" height="300" flex="1">
      <g2 transform="translate(0, 0)"></g>
    </svg>
  </div>

  <script src="js/d3.min.js"></script>
  <script>

// inspiration : https://bl.ocks.org/d3indepth/c9fd848b9410cc543a437b34c266ac64
// Create an arc generator with configuration
var arcGenerator = d3.arc()
  .innerRadius(100)
  .outerRadius(120);
/*
var arcData = [
  {label: 'A', startAngle: 0, endAngle: 0.2},
  {label: 'B', startAngle: 0.2, endAngle: 0.6},
  {label: 'C', startAngle: 0.6, endAngle: 1.4},
  {label: 'D', startAngle: 1.4, endAngle: 3},
  {label: 'E', startAngle: 3, endAngle: 2* Math.PI}
];*/


playing_speed_interval = 350;


function colcode(d){
  if(d.data.id.charAt(0) == "g"){
    return("green");
  }else if (d.data.id.charAt(0) == "e"){
    return("#dbdbdb");
  }else{
    return("#8A2BE2");
  }
}

function code_event(d){
  if(d.event == "Inv"){
    return("green");
  }else if (d.event == "Del"){
    return("red");
  }else{
    return("#8A2BE2");
  }
}


//slider
var slider = document.getElementById("slider");
var ts = document.getElementById("range");
ts.innerHTML = "1"; // Display the default slider value
slider.oninput = function() {
  ts.innerHTML = this.value;
}



d3.csv("/data/plasmid_description.csv", function(error, data) {
  if (error) throw error;
  // accessors
  columns = Object.keys( data[0] ).slice()
  var nb_col = columns.length
  var t_max = (nb_col-1)/3-1
  slider.max = t_max


  function update(ts){
    console.log("update called with ts")
    console.log(ts)

    var pos = "pos"+ts.toString()
    var length = "length"+ts.toString()
    var arcs = d3.pie()
        .sort(function(a,b){
          return (b[pos]-a[pos]);
        })
        .value(function(d) {console.log(d[pos]);return d[length];})(data);

    console.log(arcs)

    var paths = d3.select('g')
                    .selectAll('path')
                    .data(arcs)
                    
    paths.transition().duration(playing_speed_interval).attr('d', arcGenerator)
    //  .attr("fill", function(d){console.log(colcode(d));return colcode(d)})

    // Add labels, using .centroid() to position
    
   d3.select('g')
      .selectAll('text')
      .data(arcs)
      .each(function(d) {
        var centroid = arcGenerator.centroid(d);
        d3.select(this).transition().duration(playing_speed_interval)
          .attr('x', centroid[0])
          .attr('y', centroid[1])
          .attr('dy', '0.33em')
          .text(function(d){
            if(d.data.id.charAt(0) == "p"){
              return("");
            }else if(d.data.id.charAt(0) == "e"){
              return("");
            }else{
              return(d.data.id);
            }
          });
    })
  }
    /// Initialisation
    var pos = "pos0"
    var length = "length0"
    var arcs = d3.pie()
        .sort(function(a,b){
          return b[pos]-a[pos];
        })
        .value(function(d) {console.log(length,d[length]); return d[length]; })(data);

    console.log(arcs)
      d3.select('g')
      .selectAll('path')
      .data(arcs)
      .enter()
      .append('path')
      .attr('d', arcGenerator)
      .attr("fill", function(d){console.log(colcode(d));return colcode(d)})

    // Add labels, using .centroid() to position
    d3.select('g')
      .selectAll('text')
      .data(arcs)
      .enter()
      .append('text')
      .each(function(d) {
        var centroid = arcGenerator.centroid(d);
        d3.select(this)
          .attr('x', centroid[0])
          .attr('y', centroid[1])
          .attr('dy', '0.33em')
          .text(function(d){
            if(d.data.id.charAt(0) == "p"){
              return("");
            }else if(d.data.id.charAt(0) == "e"){
              return("");
            }else{
              return(d.data.id);
            }
          });
    })
  // other elements
  d3.select("#slider").on("input", function() {
    update(+this.value);
  });

  // Player 
//var i = 0
//setInterval(function(){update(1+i%2); console.log(i%2);i++;},600)    


function step(){
  console.log("doing a step")
  current_ts=parseInt(slider.value)+1
  console.log(current_ts,t_max)
  if (current_ts > t_max) {
    moving = false;
    //current_ts = 0;
    clearInterval(timer);
    // timer = 0;
    playButton.text("Play");
    console.log("Slider moving: " + moving);
  }else{
    console.log("here")
    console.log(slider.value)
    slider.value=current_ts
    console.log(slider.value)
    ts.innerHTML = slider.value; 
    console.log("here")
    update(slider.value)


  }
}

var playButton = d3.select("#play");

playButton.on("click",function(){
  var button = d3.select(this)
  if (button.text() == "Pause") {
      moving = false;
      clearInterval(timer);
      // timer = 0;
      button.text("Play");
    } else {
      moving = true;
      timer = setInterval(step,600);
      button.text("Pause");
    }
    console.log("Slider moving: " + moving);  
})

}) 
  </script>
</body>
</html>
